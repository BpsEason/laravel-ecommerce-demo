server {
    listen 80;
    listen [::]:80;
    server_name localhost; # 在開發環境使用 localhost，生產環境請替換為你的域名

    # 設定應用程式的根目錄為 Laravel 的 public 目錄
    root /var/www/html/public;

    # 設置索引檔案的順序
    index index.php index.html index.htm;

    charset utf-8;

    # 定義錯誤頁面
    error_page 404 /index.php;

    # 處理所有請求，將其重寫到 index.php (Laravel 路由)
    # 這部分邏輯只處理非靜態檔案請求，靜態檔案應由 CDN 或專用位置處理
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # 將 PHP 檔案的請求轉發給 PHP-FPM 服務
    location ~ \.php$ {
        # 如果檔案不存在，則返回 404
        try_files $uri =404;
        # `app` 是 docker-compose.yml 中 PHP-FPM 服務的名稱
        fastcgi_pass app:9000;
        fastcgi_index index.php;
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        include fastcgi_params;

        # 增加一些緩衝區配置以提高性能
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
    }

    # 禁止訪問隱藏檔案 (例如 .htaccess, .git, .env)
    location ~ /\. {
        deny all;
    }

    # 禁止訪問 .env 檔案
    location ~ \.env {
        deny all;
    }

    # 禁止訪問 storage 目錄
    location /storage {
        deny all;
        # 如果你需要透過 Nginx 提供 storage 下的檔案 (例如用戶上傳的圖片)，
        # 你需要在 Laravel 中創建一個符號連結到 public 目錄，
        # 或者為此設置一個單獨的 location 塊，並確保其權限正確。
        # 範例 (如果 storage 是通過 symlink 到 public/storage):
        # try_files $uri $uri/ =404;
    }

    # 靜態檔案處理：
    # 假設大部分靜態資源（CSS, JS, 圖片等）將通過 CDN 提供服務。
    # Nginx 這裡只處理那些不是通過 CDN 提供的「本地」靜態檔案。
    # 如果你的所有靜態檔案都通過 CDN，這部分可以更精簡。
    location ~* \.(css|js|gif|png|jpg|jpeg|ico|svg|webp)$ {
        # 設置緩存頭，鼓勵瀏覽器和 CDN 緩存這些資源
        expires 1y;
        add_header Cache-Control "public, immutable"; # immutable 標記表示檔案內容不變
        access_log off; # 不記錄靜態檔案的訪問日誌
        log_not_found off; # 不記錄未找到靜態檔案的錯誤

        # 允許跨域請求 (如果你的 CDN 和應用在不同域，或者需要支援 CORS)
        # add_header Access-Control-Allow-Origin "*";
    }

    # 啟用 gzip 壓縮以減少傳輸大小
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

    # 增加安全性頭部
    add_header X-Frame-Options "SAMEORIGIN";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options "nosniff";
    add_header Referrer-Policy "no-referrer-when-downgrade";
    # Content-Security-Policy 可以根據你的應用需求詳細配置
    # add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.google-analytics.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://cdn.example.com;";

    # HTTP Strict Transport Security (HSTS) - 生產環境建議開啟
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";

    # 防止緩存敏感響應
    # add_header Pragma "no-cache";
    # add_header Expires "Fri, 01 Jan 1990 00:00:00 GMT";
    # add_header Cache-Control "no-store, no-cache, must-revalidate, post-check=0, pre-check=0";
}
